<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LIVE LOG</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
ã€€ã€€ã€€<style>

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header class="app-header">
    <div class="confetti" style="left:10%; animation-delay: 0s; background:#ffcc00;"></div>
    <div class="confetti" style="left:30%; animation-delay: 1.5s; background:#ffffff;"></div>
    <div class="confetti" style="left:55%; animation-delay: 0.5s; background:#ff9500;"></div>
    <div class="confetti" style="left:85%; animation-delay: 2.2s; background:#ffffff;"></div>
    
    <div class="header-title">LIVEDIARY</div>
</header>

<main id="app">
    <div id="page-home" class="tab-content active">
        <div class="card">
            <h2>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ–°è¦è¿½åŠ </h2> <div class="add-artist-form">
                <input type="text" id="new-artist-name" placeholder="åå‰ã‚’å…¥åŠ›">
                <button onclick="addArtist()" class="btn-add-inline">è¿½åŠ </button>
            </div>
        </div>
            <div class="card">
                <span class="section-title">æ–°ã—ã„ãƒ©ã‚¤ãƒ–ã®è¨˜éŒ²</span>
                <select id="live-artist-select"><option value="">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠ</option></select>
                <input type="date" id="live-date"> 
                <input type="text" id="live-name" placeholder="å…¬æ¼”ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰">
                    <input type="text" id="live-venue" list="venue-list" placeholder="ä¼šå ´åã‚’å…¥åŠ›">
                    <datalist id="venue-list"></datalist>
                <select id="live-pref">
                    <option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>
                    <option value="åŒ—æµ·é“">åŒ—æµ·é“</option><option value="é’æ£®çœŒ">é’æ£®çœŒ</option><option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option><option value="å®®åŸçœŒ">å®®åŸçœŒ</option><option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option><option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option><option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option><option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option><option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option><option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option><option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option><option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option><option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option><option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option><option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option><option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option><option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option><option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option><option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option><option value="é•·é‡çœŒ">é•·é‡çœŒ</option><option value="å²é˜œçœŒ">å²é˜œçœŒ</option><option value="é™å²¡çœŒ">é™å²¡çœŒ</option><option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option><option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option><option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option><option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option><option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option><option value="å…µåº«çœŒ">å…µåº«çœŒ</option><option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option><option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option><option value="é³¥å–çœŒ">é³¥å–çœŒ</option><option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option><option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option><option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option><option value="å±±å£çœŒ">å±±å£çœŒ</option><option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option><option value="é¦™å·çœŒ">é¦™å·çœŒ</option><option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option><option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option><option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option><option value="ä½è³€çœŒ">ä½è³€çœŒ</option><option value="é•·å´çœŒ">é•·å´çœŒ</option><option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option><option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option><option value="å®®å´çœŒ">å®®å´çœŒ</option><option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option><option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option><option value="æµ·å¤–">æµ·å¤–</option>
                </select>
                <textarea id="live-memo" placeholder="ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³" rows="3"></textarea>
                <button onclick="addLive()" class="accent-btn">ãƒ©ã‚¤ãƒ–ã‚’ç™»éŒ²ã™ã‚‹</button>
            </div>
        </div>

        <div id="page-history" class="tab-content"><div id="history-list"></div></div>
        
        
        <div id="page-stats" class="tab-content">
    <div class="card" style="background: linear-gradient(135deg, #FFD700, #FFA500); border: none; margin-bottom: 15px;">
        <button onclick="openShareModal()" style="width: 100%; background: none; border: none; color: #fff; font-weight: 800; font-size: 1.1rem; padding: 10px; cursor: pointer;">
            ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹
        </button>
    </div>

    <div class="card" style="margin-bottom: 15px;">
        <span class="section-title">ğŸ“Š è¡¨ç¤ºå¯¾è±¡</span>
        <select id="stats-filter-artist" onchange="renderStats()" style="margin-bottom:0;">
            <option value="all">ã™ã¹ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</option>
        </select>
    </div>

    <div class="card">
        <div style="max-width: 200px; margin: 0 auto; position: relative;">
            <canvas id="artistChart"></canvas>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -40%); text-align: center;">
                <div style="font-size: 0.75rem; color: #8e8e93; font-weight: bold;" id="stats-total-label">Total</div>
                <div id="total-count-display" style="font-size: 1.8rem; font-weight: bold; color: var(--primary-color);">0</div>
            </div>
        </div>
    </div>

    <div id="stats-artist-ranking"></div>
    <div id="stats-song-ranking"></div>

    <div id="stats-yearly-ranking"></div>
    
    <div id="stats-venue-ranking"></div>

    <div class="card" style="padding: 20px; border: 1px solid #f2f2f7;">
        <span class="section-title">ğŸ—º <span id="map-target-name">å…¨å›½</span>é å¾ãƒãƒƒãƒ—</span>
        <div id="japan-map" style="margin: 15px 0;"></div>
        <div style="text-align: center; font-size: 0.85rem; color: #8e8e93; margin-top: 10px; background: #f9f9fb; padding: 8px; border-radius: 8px;">
            åˆ¶è¦‡: <span id="visited-pref-count" style="font-weight:bold; color:var(--primary-color); font-size: 1.1rem;">0</span> <span style="font-size: 0.7rem;">/ 47 éƒ½é“åºœçœŒ</span>
        </div>
    </div>

    <div id="stats-pref-ranking"></div>
</div>


<div id="page-settings" class="tab-content">
    <div class="app-version-info" style="text-align: center; font-size: 12px; color: #8e8e93; margin-bottom: 10px;">Ver 1.0.0</div>

<div class="settings-card">
    <span class="section-title">ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢</span>
    <div class="backup-controls">
        <button onclick="exportData()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        <button onclick="importData()">ãƒªã‚¹ãƒˆã‚¢</button>
    </div>
</div>

    <div class="card">
        <span class="section-title">ç™»éŒ²ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ç®¡ç†</span>
        <input type="text" id="artist-search-input" placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã§æ¤œç´¢..." oninput="renderArtistManager()" style="margin-bottom: 10px;">
        
        <div id="artist-manager-list" style="max-height: 300px; overflow-y: auto; border-top: 1px solid #eee;">
            </div>
    </div>
</div>


    </main>

    <div id="modal-overlay" class="modal-overlay hidden" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-title" style="margin:0; font-size:1rem;">ãƒ©ã‚¤ãƒ–è©³ç´°</h3>
                <button onclick="closeModal()" class="close-btn">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="modal-view">
                    <h2 id="view-live-name" style="color:var(--primary-color); margin-top:0;"></h2>
                    <div id="live-details-info"></div>
                    <div id="setlist-display" style="background:#f9f9fb; padding:15px; border-radius:10px; margin-top:15px;"></div>
                    <button onclick="switchEditMode()" class="primary-btn" style="margin-top:20px;">ç·¨é›†ã™ã‚‹</button>
                </div>
                <div id="modal-edit" class="hidden">
                    <input type="date" id="edit-date">
                    <input type="text" id="edit-name" placeholder="ãƒ©ã‚¤ãƒ–å">
                    <input type="text" id="edit-venue" placeholder="ä¼šå ´å">
                        <select id="edit-pref">
                        <option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>
                     <option value="åŒ—æµ·é“">åŒ—æµ·é“</option><option value="é’æ£®çœŒ">é’æ£®çœŒ</option><option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option><option value="å®®åŸçœŒ">å®®åŸçœŒ</option><option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option><option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option><option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option><option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option><option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option><option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option><option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option><option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option><option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option><option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option><option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option><option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option><option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option><option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option><option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option><option value="é•·é‡çœŒ">é•·é‡çœŒ</option><option value="å²é˜œçœŒ">å²é˜œçœŒ</option><option value="é™å²¡çœŒ">é™å²¡çœŒ</option><option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option><option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option><option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option><option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option><option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option><option value="å…µåº«çœŒ">å…µåº«çœŒ</option><option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option><option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option><option value="é³¥å–çœŒ">é³¥å–çœŒ</option><option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option><option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option><option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option><option value="å±±å£çœŒ">å±±å£çœŒ</option><option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option><option value="é¦™å·çœŒ">é¦™å·çœŒ</option><option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option><option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option><option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option><option value="ä½è³€çœŒ">ä½è³€çœŒ</option><option value="é•·å´çœŒ">é•·å´çœŒ</option><option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option><option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option><option value="å®®å´çœŒ">å®®å´çœŒ</option><option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option><option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option><option value="æµ·å¤–">æµ·å¤–</option>
    </select>
                    <textarea id="edit-memo" rows="3" placeholder="ãƒ¡ãƒ¢"></textarea>
                    <textarea id="edit-setlist" rows="5" placeholder="ã‚»ãƒˆãƒªï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰"></textarea>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button onclick="saveEdit()" class="primary-btn" style="flex:2;">ä¿å­˜</button>
                        <button onclick="deleteLive()" style="flex:1; background:white; color:red; border:1px solid red; border-radius:10px;">å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div id="share-modal" class="modal-overlay hidden" onclick="closeShareModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>ãƒ¬ãƒãƒ¼ãƒˆæ¡ä»¶</h3>
            <button onclick="closeShareModal()" class="close-btn">Ã—</button>
        </div>
        
        <div class="modal-body">
            <span class="section-title">1. é›†è¨ˆæœŸé–“ï¼ˆPeriodï¼‰</span>
            <select id="share-period-type">
                <option value="all">ALL TIMEï¼ˆå…¨æœŸé–“ï¼‰</option>
                </select>
            
            <span class="section-title" style="margin-top:15px;">2. ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼ˆArtistï¼‰</span>
            <select id="share-artist-type">
                <option value="all">ALL Artistsï¼ˆå…¨å¯¾è±¡ï¼‰</option>
                </select>


<span class="section-title" style="margin-top:20px;">3. æ¨ã—è‰²ï¼ˆãƒ†ãƒ¼ãƒï¼‰ã‚’é¸ã¶</span>
<div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px;">
    
    <div style="display: flex; justify-content: space-between; max-width: 210px;">
        <button onclick="setTheme('#af52de')" title="ç´«" style="width:34px; height:34px; background:#af52de; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);"></button>
        <button onclick="setTheme('#ff3b30')" title="èµ¤" style="width:34px; height:34px; background:#ff3b30; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);"></button>
        <button onclick="setTheme('#007130')" title="ç·‘" style="width:34px; height:34px; background:#007130; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);"></button>
        <button onclick="setTheme('#5ac8fa')" title="æ°´è‰²" style="width:34px; height:34px; background:#5ac8fa; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);"></button>
        <button onclick="setTheme('#34c759')" title="é»„ç·‘" style="width:34px; height:34px; background:#34c759; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);"></button>
    </div>

    <div style="display: flex; align-items: center; max-width: 275px;">
        <div style="display: flex; gap: 10px; width: 122px;">
            <button onclick="setTheme('#ffb6c1')" title="ãƒ”ãƒ³ã‚¯" style="width:34px; height:34px; background:#ffb6c1; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);"></button>
            <button onclick="setTheme('#ffcc00')" title="é»„è‰²" style="width:34px; height:34px; background:#ffcc00; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);"></button>
            <button onclick="setTheme('#ffffff')" title="ç™½" style="width:34px; height:34px; background:#ffffff; border-radius:50%; border:1px solid #c7c7cc; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.1);"></button>
        </div>
        
        <div style="flex-grow: 1;"></div> 

        <div style="height: 30px; border-left: 2px solid #eee; margin-right: 12px;"></div>

        <div style="display:flex; flex-direction:column; align-items:center; width: 40px;">
            <input type="color" id="custom-theme-color" onchange="setTheme(this.value)" style="width:34px; height:34px; padding:0; border:none; background:none; cursor:pointer;">
            <span style="font-size:0.6rem; color:#8e8e93; margin-top: 2px;">è‡ªç”±è‰²</span>
        </div>
    </div>
</div>

            <button onclick="generateReport()" class="accent-btn" style="background: var(--primary-color); height: 50px; font-size: 1.1rem;">ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º</button>
        </div>
    </div>
</div>






<div id="report-preview-overlay" class="modal-overlay hidden" onclick="this.classList.add('hidden')">
    <div id="report-card-container" onclick="event.stopPropagation()"></div>
    
    <div class="report-action-buttons" onclick="event.stopPropagation()">
        <button onclick="saveReportImage()" class="primary-btn" style="margin-top:20px; width:200px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">ç”»åƒã®ä¿å­˜ï¼ã‚·ã‚§ã‚¢</button>
        <button onclick="document.getElementById('report-preview-overlay').classList.add('hidden')" style="background:none; border:none; color:white; margin-top:15px; text-decoration:underline; font-size:0.9rem; opacity:0.8;">é–‰ã˜ã‚‹</button>
    </div>
</div>

    <nav class="tab-bar">
        <button onclick="showPage('home')" id="tab-home" class="active"><span class="icon">â™¢</span><span>ãƒ›ãƒ¼ãƒ </span></button>
        <button onclick="showPage('history')" id="tab-history"><span class="icon">â–¤</span><span>å±¥æ­´</span></button>
        <button onclick="showPage('stats')" id="tab-stats"><span class="icon">â—‹</span><span>çµ±è¨ˆ</span></button>
        <button onclick="showPage('settings')" id="tab-settings"><span class="icon">âš™</span><span>ç®¡ç†</span></button>
    </nav>

    <script>
    const prefCodes = {
    "åŒ—æµ·é“":"HKD","é’æ£®çœŒ":"AOM","å²©æ‰‹çœŒ":"IWT","å®®åŸçœŒ":"MYG","ç§‹ç”°çœŒ":"AKT","å±±å½¢çœŒ":"YGT","ç¦å³¶çœŒ":"FKS",
    "èŒ¨åŸçœŒ":"IBR","æ ƒæœ¨çœŒ":"TCG","ç¾¤é¦¬çœŒ":"GMA","åŸ¼ç‰çœŒ":"STM","åƒè‘‰çœŒ":"CHB","æ±äº¬éƒ½":"TKY","ç¥å¥ˆå·çœŒ":"KNG",
    "æ–°æ½ŸçœŒ":"NGT","å¯Œå±±çœŒ":"TYM","çŸ³å·çœŒ":"ISK","ç¦äº•çœŒ":"FKI","å±±æ¢¨çœŒ":"YNS","é•·é‡çœŒ":"NGN","å²é˜œçœŒ":"GIF",
    "é™å²¡çœŒ":"SZK","æ„›çŸ¥çœŒ":"AIC","ä¸‰é‡çœŒ":"MIE","æ»‹è³€çœŒ":"SHG","äº¬éƒ½åºœ":"KYT","å¤§é˜ªåºœ":"OSK","å…µåº«çœŒ":"HYG",
    "å¥ˆè‰¯çœŒ":"NRA","å’Œæ­Œå±±çœŒ":"WKY","é³¥å–çœŒ":"TTR","å³¶æ ¹çœŒ":"SMN","å²¡å±±çœŒ":"OKY","åºƒå³¶çœŒ":"HRS","å±±å£çœŒ":"YMG",
    "å¾³å³¶çœŒ":"TKS","é¦™å·çœŒ":"KGW","æ„›åª›çœŒ":"EHM","é«˜çŸ¥çœŒ":"KCH","ç¦å²¡çœŒ":"FUK","ä½è³€çœŒ":"SAG","é•·å´çœŒ":"NGS",
    "ç†Šæœ¬çœŒ":"KMT","å¤§åˆ†çœŒ":"OIT","å®®å´çœŒ":"MZA","é¹¿å…å³¶çœŒ":"KGS","æ²–ç¸„çœŒ":"OKN"
};

        let db = JSON.parse(localStorage.getItem('live_app_db') || '{"artists":[], "lives":[]}');
        let currentId = null; let chart = null;
        const refinedColors = ['#007130', '#34c759', '#30b0c7', '#007aff', '#5856d6', '#ff3b30', '#ff9500'];
        const prefOrder = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ","æµ·å¤–"];

window.onload = () => { 
    updateArtistSelect(); 
    updateVenueSuggestions(); // â† ã“ã‚Œã‚’è¿½åŠ 
    showPage('home'); 
    document.getElementById('live-date').value = new Date().toISOString().split('T')[0]; 
};

        function save() { localStorage.setItem('live_app_db', JSON.stringify(db)); }

        function showPage(id) {
            document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-bar button').forEach(b => b.classList.remove('active'));
            document.getElementById('page-'+id).classList.add('active');
            document.getElementById('tab-'+id).classList.add('active');
            if(id==='history') renderHistory();
            if(id==='stats') renderStats();
            if(id==='settings') renderArtistManager();
        }

        function updateArtistSelect() {
            const s = document.getElementById('live-artist-select');
            s.innerHTML = '<option value="">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠ</option>' + db.artists.sort().map(a=>`<option value="${a}">${a}</option>`).join('');
        }

        function addArtist() {
            const v = document.getElementById('new-artist-name').value.trim();
            if(!v || db.artists.includes(v)) return;
            db.artists.push(v); save(); updateArtistSelect();
            document.getElementById('new-artist-name').value = '';
        }

function updateVenueSuggestions() {
    const venueListElement = document.getElementById('venue-list');
    if (!venueListElement) return;

    // å…¨ã¦ã®ãƒ©ã‚¤ãƒ–å±¥æ­´ã‹ã‚‰ä¼šå ´åã‚’å–å¾—ã—ã€é‡è¤‡ã‚’å‰Šé™¤ã—ã¦ã‚½ãƒ¼ãƒˆ
    const venues = [...new Set(db.lives.map(live => live.venue))]
        .filter(venue => venue && venue.trim() !== "")
        .sort();

    // datalistã®ä¸­èº«ã‚’æ›´æ–°
    venueListElement.innerHTML = venues
        .map(venue => `<option value="${venue}">`)
        .join('');
}





        function addLive() {
            const art = document.getElementById('live-artist-select').value;
            const day = document.getElementById('live-date').value;
            if(!art || !day) return alert('å…¥åŠ›ä¸è¶³');
            db.lives.push({ id:Date.now(), artist:art, date:day, name:document.getElementById('live-name').value, venue:document.getElementById('live-venue').value, pref:document.getElementById('live-pref').value, memo:document.getElementById('live-memo').value, setlist:[] });
            save();
            updateVenueSuggestions(); // â† ç™»éŒ²å¾Œã«æœ€æ–°ã®ä¼šå ´ã‚’ãƒªã‚¹ãƒˆã«åæ˜ 
                        // --- ã“ã“ã‹ã‚‰å…¥åŠ›ã‚¨ãƒªã‚¢ã®åˆæœŸåŒ–å‡¦ç†ã‚’è¿½åŠ  ---
            document.getElementById('live-artist-select').value = '';
            document.getElementById('live-name').value = '';
            document.getElementById('live-venue').value = '';
            document.getElementById('live-pref').value = '';
            document.getElementById('live-memo').value = '';
            // æ—¥ä»˜ã¯ä»Šæ—¥ã®æ—¥ä»˜ã«æˆ»ã™ï¼ˆãŠå¥½ã¿ã§ï¼‰
            document.getElementById('live-date').value = new Date().toISOString().split('T')[0];
            
            showPage('history');
        }

// --- ã“ã“ã‹ã‚‰å·®ã—æ›¿ãˆ ---
        function renderHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            db.artists.sort().forEach(art => {
                const lives = db.lives.filter(l=>l.artist===art).sort((a,b)=>new Date(b.date)-new Date(a.date));
                if(!lives.length) return;
                const card = document.createElement('div');
                card.className = 'card'; card.style.padding = '0';
                card.innerHTML = `<div style="padding:15px; font-weight:bold; cursor:pointer;" onclick="this.nextElementSibling.classList.toggle('hidden')">${art} <span style="float:right; color:var(--primary-color)">${lives.length}å…¬æ¼”</span></div>
                    <div class="hidden" style="border-top:1px solid #eee;">
                    ${lives.map(l=>`
                        <div class="live-history-item" onclick="openDetail(${l.id})" style="padding:14px; border-bottom:1px solid #f2f2f7; cursor:pointer;">
                            <div style="font-size:0.75rem; color:#8e8e93;">${l.date}</div>
                            <div style="font-weight:bold;">${l.name||'(ç„¡é¡Œ)'}</div>
                            <div class="history-venue" style="font-size:0.85rem; color:#666; margin-top:4px;">ğŸ“ ${l.venue || 'ä¼šå ´æœªç™»éŒ²'}</div>
                        </div>`).join('')}
                    </div>`;
                container.appendChild(card);
            });
        }

        function openDetail(id) {
            currentId = id; 
            const l = db.lives.find(x=>x.id===id);
            if(!l) return;
            // è¡¨ç¤ºå†…å®¹ã®ã‚»ãƒƒãƒˆ
            document.getElementById('view-live-name').innerText = l.name || 'ãƒ©ã‚¤ãƒ–è©³ç´°';
            document.getElementById('live-details-info').innerHTML = `<p>ğŸ“… ${l.date}</p><p>ğŸ“ ${l.venue || 'æœªç™»éŒ²'} (${l.pref || '-'})</p><p>${l.memo||''}</p>`;
            document.getElementById('setlist-display').innerHTML = l.setlist?.length ? l.setlist.map((s,i)=>`<div>${i+1}. ${s}</div>`).join('') : 'ã‚»ãƒˆãƒªæœªç™»éŒ²';
            
            // é‡è¦ï¼šã¾ãšè©³ç´°ç”»é¢ã‚’è¦‹ã›ã¦ã€ç·¨é›†ç”»é¢ã‚’éš ã™
            document.getElementById('modal-view').classList.remove('hidden');
            document.getElementById('modal-edit').classList.add('hidden');
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

// ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°ã‚’ä¿®æ­£
function switchEditMode() {
    const l = db.lives.find(x=>x.id===currentId);
    if(!l) return;
    
    document.getElementById('edit-date').value = l.date;
    document.getElementById('edit-name').value = l.name || '';
    document.getElementById('edit-venue').value = l.venue || '';
    document.getElementById('edit-pref').value = l.pref || ''; // â† è¿½åŠ ï¼šç¾åœ¨ã®éƒ½é“åºœçœŒã‚’ã‚»ãƒƒãƒˆ
    document.getElementById('edit-memo').value = l.memo || '';
    document.getElementById('edit-setlist').value = (l.setlist||[]).join('\n');
    
    document.getElementById('modal-view').classList.add('hidden');
    document.getElementById('modal-edit').classList.remove('hidden');
}

// ç·¨é›†ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°ã‚’ä¿®æ­£
function saveEdit() {
    const l = db.lives.find(x=>x.id===currentId);
    l.date = document.getElementById('edit-date').value;
    l.name = document.getElementById('edit-name').value;
    l.venue = document.getElementById('edit-venue').value;
    l.pref = document.getElementById('edit-pref').value; // â† è¿½åŠ ï¼šæ–°ã—ã„éƒ½é“åºœçœŒã‚’ä¿å­˜
    l.memo = document.getElementById('edit-memo').value;
    l.setlist = document.getElementById('edit-setlist').value.split('\n').filter(s=>s.trim());
    
    save(); 
    updateVenueSuggestions(); // ä¼šå ´ãƒã‚¹ã‚¿ãƒ¼ã‚‚æ›´æ–°
    closeModal(); 
    renderHistory();
}

        function deleteLive() { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ db.lives=db.lives.filter(x=>x.id!==currentId); save(); closeModal(); renderHistory(); } }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); document.getElementById('modal-view').classList.remove('hidden'); document.getElementById('modal-edit').classList.add('hidden'); }



// ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆé¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆçµ±è¨ˆã‚¿ãƒ–ã‚’é–‹ããŸã³ã«æœ€æ–°ã«ã™ã‚‹ï¼‰
function updateStatsFilter() {
    const s = document.getElementById('stats-filter-artist');
    const current = s.value;
    // é‡è¤‡ãªã—ã§ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆä¸€è¦§
    s.innerHTML = '<option value="all">ã™ã¹ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</option>' + 
                  [...db.artists].sort().map(a => `<option value="${a}">${a}</option>`).join('');
    s.value = current || 'all';
}

// çµ±è¨ˆæç”»ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
function renderStats() {
    updateStatsFilter();
    const filterArtist = document.getElementById('stats-filter-artist').value;
    const isAll = filterArtist === 'all';

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const targetLives = isAll ? db.lives : db.lives.filter(l => l.artist === filterArtist);

    // 1. å¹´åˆ¥ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
    // --- å¹´åˆ¥é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ0ä»¶è£œå®Œç‰ˆï¼‰ ---
    const yearlyCounts = {};
    if (db.lives.length > 0) {
        // å…¨ãƒ‡ãƒ¼ã‚¿ã®ä¸­ã‹ã‚‰ã€Œä¸€ç•ªå¤ã„å¹´ã€ã‚’å–å¾—
        const yearsInData = db.lives.map(l => new Date(l.date).getFullYear()).filter(y => !isNaN(y));
        const startYear = Math.min(...yearsInData);
        // ã€Œä»Šå¹´ã€ã‚’å–å¾—
        const currentYear = new Date().getFullYear();

        // æœ€åˆã®ãƒ©ã‚¤ãƒ–ã®å¹´ã‹ã‚‰ä»Šå¹´ã¾ã§ã‚’ 0 ã§åˆæœŸåŒ–ï¼ˆã“ã‚Œã§0ä»¶ã®å¹´ã‚‚åŸ‹ã¾ã‚‹ï¼‰
        for (let y = startYear; y <= currentYear; y++) {
            yearlyCounts[y] = 0;
        }

        // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå…¨å¯¾è±¡ or ç‰¹å®šã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼‰ã«ä¸€è‡´ã™ã‚‹åˆ†ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        targetLives.forEach(l => {
            const year = new Date(l.date).getFullYear();
            if (!isNaN(year)) yearlyCounts[year]++;
        });
    }

    // é›†è¨ˆç”¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
    const counts = { artist: {}, song: {}, venue: {}, pref: {} };

    targetLives.forEach(l => {
        counts.artist[l.artist] = (counts.artist[l.artist] || 0) + 1;
        counts.venue[l.venue] = (counts.venue[l.venue] || 0) + 1;
        counts.pref[l.pref] = (counts.pref[l.pref] || 0) + 1;
        if (l.setlist && Array.isArray(l.setlist)) {
            l.setlist.forEach(s => counts.song[s] = (counts.song[s] || 0) + 1);
        }
    });

    // [ã‚°ãƒ©ãƒ•æç”»]
    document.getElementById('total-count-display').innerText = targetLives.length;
    document.getElementById('stats-total-label').innerText = isAll ? "Total" : "Lives";
    
    const sortedArtEntries = Object.entries(counts.artist).sort((a,b) => b[1]-a[1]);
    if(chart) chart.destroy();
    chart = new Chart(document.getElementById('artistChart'), { 
        type: 'doughnut', 
        data: { 
            labels: sortedArtEntries.map(s=>s[0]), 
            datasets: [{ data: sortedArtEntries.map(s=>s[1]), backgroundColor: refinedColors, borderWidth: 0 }] 
        }, 
        options: { cutout: '80%', plugins: { legend: { display: false } } } 
    });

    // [å„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®æç”»]
    // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå…¨ä½“è¡¨ç¤ºã®æ™‚ã®ã¿è¡¨ç¤ºï¼‰
    if(isAll) {
        renderRanking('stats-artist-ranking', 'ğŸ† ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ', counts.artist, 'å›', true);
    } else {
        document.getElementById('stats-artist-ranking').innerHTML = '';
    }

    // ã€æ–°è¨­ã€‘å¹´åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®æç”»
    renderYearlyRanking('stats-yearly-ranking', yearlyCounts);

    renderRanking('stats-song-ranking', 'ğŸµ æ›²', counts.song, 'å›');
    renderRanking('stats-venue-ranking', 'ğŸŸ ä¼šå ´', counts.venue, 'å›');
    
    // [åœ°å›³æç”»]
    const visited = [...new Set(targetLives.map(l => l.pref).filter(p => p && p !== 'æµ·å¤–' && p !== ''))];
    renderJapanMap(visited);
    document.getElementById('visited-pref-count').innerText = visited.length;
    document.getElementById('map-target-name').innerText = isAll ? 'å…¨å›½' : filterArtist;

    renderRanking('stats-pref-ranking', 'ğŸ“ éƒ½é“åºœçœŒ', counts.pref, 'å›');
}

// å¹´åˆ¥å°‚ç”¨ã®æç”»é–¢æ•°
function renderYearlyRanking(id, dataObj) {
    const container = document.getElementById(id);
    const sortedYears = Object.entries(dataObj).sort((a, b) => b[0] - a[0]);

    // 1ä»¶ã‚‚ãƒ‡ãƒ¼ã‚¿ï¼ˆå¹´ï¼‰ãŒãªã„å ´åˆ
    if (sortedYears.length === 0) {
        container.innerHTML = `<div class="card"><span class="section-title">ğŸ“… å¹´åˆ¥å‚æˆ¦æ•°</span><div style="text-align:center; padding:20px; color:#8e8e93; font-size:0.9rem;">ãƒ©ã‚¤ãƒ–ã‚’ç™»éŒ²ã™ã‚‹ã¨å¹´è¡¨ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div></div>`;
        return;
    }

    const maxCount = Math.max(...Object.values(dataObj), 1);
    let html = `<div class="card"><span class="section-title">ğŸ“… å¹´åˆ¥å‚æˆ¦æ•°</span>`;

    sortedYears.forEach((entry, i) => {
        const year = entry[0];
        const count = entry[1];
        const barWidth = (count / maxCount) * 100;
        
        // 11ä½ä»¥é™ã‚’éš ã™è¨­å®š
        const isHidden = i >= 10;
        const displayStyle = isHidden ? 'none' : 'flex';
        const hiddenClass = isHidden ? 'rank-item-hidden' : '';

        html += `
            <div class="stats-list-item ${hiddenClass}" data-group="${id}" style="padding: 12px 0; align-items:center; display:${displayStyle}; width:100%;">
                <div class="year-text" style="width:50px; flex-shrink:0; font-weight:bold; ${count === 0 ? 'opacity:0.3;' : ''}">${year}</div>
                <div class="yearly-bar-container" style="flex:1; height:8px; background:#f2f2f7; border-radius:4px; margin:0 10px; overflow:hidden;">
                    <div class="yearly-bar-fill" style="width: ${barWidth}%; height:100%; background:linear-gradient(90deg, #ff9500, #ffcc00); border-radius:4px; opacity:${count === 0 ? '0' : '1'};"></div>
                </div>
                <div style="font-weight:900; color:${count === 0 ? '#c7c7cc' : 'var(--primary-color)'}; min-width:35px; text-align:right;">
                    ${count}<small style="font-size:0.6rem; font-weight:bold;">å›</small>
                </div>
            </div>`;
    });

    if (sortedYears.length > 10) {
        html += `<button id="${id}-btn" class="show-more-btn" onclick="toggleRankingNew('${id}')">ã‚‚ã£ã¨è¦‹ã‚‹ â–¼</button>`;
    }

    html += '</div>';
    container.innerHTML = html;
}

// çµ±è¨ˆæç”»å†…ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
function renderRanking(id, title, dataObj, unit, isArtistRank = false) {
    const container = document.getElementById(id);
    const sorted = Object.entries(dataObj)
        .filter(e => e[0] && e[0] !== 'undefined' && e[0] !== '')
        .sort((a,b) => b[1]-a[1]);
    
    if (sorted.length === 0) { container.innerHTML = ''; return; }

    let html = `<div class="card"><span class="section-title">${title}ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>`;
    let lastVal = -1;

    sorted.forEach((entry, i) => {
        const currentRank = i + 1;
        const rankText = entry[1] === lastVal ? '' : currentRank + 'ä½';
        lastVal = entry[1];
        
        const isHidden = currentRank > 10;
        const displayStyle = isHidden ? 'none' : 'flex';
        const hiddenClass = isHidden ? 'rank-item-hidden' : '';
        
        // è©³ç´°è¡¨ç¤ºç”¨ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ä½œæˆ
        const detailId = `detail-${id}-${i}`;

        html += `
            <div class="stats-list-item-container ${hiddenClass}" data-group="${id}" style="display:${displayStyle}; flex-direction:column; width:100%;">
                <div class="stats-list-item" style="align-items:center; width:100%; border-bottom:1px solid #f2f2f7;">
                    <div class="rank-num" style="min-width:45px; flex-shrink:0;">${rankText}</div>
                    <div style="flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; cursor:pointer; font-weight:500;" 
                         onclick="${isArtistRank ? `switchStatsTarget('${entry[0]}')` : `toggleStatsDetail('${detailId}', '${id}', '${entry[0].replace(/'/g, "\\'")}')`}">
                        ${entry[0]}
                    </div>
                    <div style="font-weight:bold; color:var(--primary-color); margin-left:10px; flex-shrink:0;">
                        ${entry[1]}<small style="font-size:0.6rem;">${unit}</small>
                    </div>
                </div>
                <div id="${detailId}" class="stats-detail-list hidden"></div>
            </div>`;
    });

    if (sorted.length > 10) {
        html += `<button id="${id}-btn" class="show-more-btn" onclick="toggleRankingNew('${id}')">ã‚‚ã£ã¨è¦‹ã‚‹ â–¼</button>`;
    }

    html += '</div>';
    container.innerHTML = html;
}

function toggleStatsDetail(detailId, type, value) {
    const detailDiv = document.getElementById(detailId);
    
    // ã™ã§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹ï¼ˆãƒˆã‚°ãƒ«ï¼‰
    if (!detailDiv.classList.contains('hidden')) {
        detailDiv.classList.add('hidden');
        return;
    }

    // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’å–å¾—
    const filterArtist = document.getElementById('stats-filter-artist').value;
    const isFiltered = filterArtist !== 'all';

    // è©²å½“ã™ã‚‹ãƒ©ã‚¤ãƒ–ã‚’æŠ½å‡º
    let filteredLives = db.lives.filter(l => {
        const matchesArtist = isFiltered ? l.artist === filterArtist : true;
        let matchesValue = false;
        if (type === 'stats-song-ranking') matchesValue = l.setlist && l.setlist.includes(value);
        if (type === 'stats-venue-ranking') matchesValue = l.venue === value;
        if (type === 'stats-pref-ranking') matchesValue = l.pref === value;
        return matchesArtist && matchesValue;
    });

    // æ—¥ä»˜é †ï¼ˆæ–°ã—ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
    filteredLives.sort((a, b) => new Date(b.date) - new Date(a.date));

    // HTMLç”Ÿæˆ
    let html = '';
    filteredLives.forEach(l => {
        const artistSpan = isFiltered ? '' : `<span class="stats-detail-artist">${l.artist}</span><br>`;
        
        let subInfo = '';
        if (type === 'stats-song-ranking') subInfo = ` @ ${l.venue || 'ä¼šå ´æœªè¨­å®š'}`;
        if (type === 'stats-venue-ranking') subInfo = ` (${l.pref || '-'})`;
        if (type === 'stats-pref-ranking') subInfo = ` @ ${l.venue || 'ä¼šå ´æœªè¨­å®š'}`;

        html += `
            <div class="stats-detail-item">
                <span class="stats-detail-date">${l.date}</span>
                ${artistSpan}
                <span style="color:#444;">${l.name || '(ç„¡é¡Œ)'}</span>
                <span style="color:#8e8e93; font-size:0.75rem;">${subInfo}</span>
            </div>`;
    });

    detailDiv.innerHTML = html;
    detailDiv.classList.remove('hidden');
}


function toggleRankingNew(id) {
    const items = document.querySelectorAll(`[data-group="${id}"].rank-item-hidden`);
    const btn = document.getElementById(id + '-btn');
    const isOpening = btn.innerText.includes('ã‚‚ã£ã¨è¦‹ã‚‹');

    items.forEach(item => {
        // blockã§ã¯ãªãã€çµ¶å¯¾ã« flex ã‚’æŒ‡å®š
        item.style.setProperty('display', isOpening ? 'flex' : 'none', 'important');
    });

    btn.innerText = isOpening ? 'é–‰ã˜ã‚‹ â–²' : 'ã‚‚ã£ã¨è¦‹ã‚‹ â–¼';
}



// ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰å€‹åˆ¥ã®çµ±è¨ˆã«é£›ã°ã™é–¢æ•°
function switchStatsTarget(name) {
    document.getElementById('stats-filter-artist').value = name;
    renderStats();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

        // åœ°å›³ã‚’ç”Ÿæˆã™ã‚‹å°‚ç”¨é–¢æ•°
function renderJapanMap(visited) {
    const container = document.getElementById('japan-map');
    if (!container) return;

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸç¾åœ¨ã®ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€å„éƒ½é“åºœçœŒã®è¨ªå•å›æ•°ã‚’é›†è¨ˆ
    const filterArtist = document.getElementById('stats-filter-artist').value;
    const targetLives = filterArtist === 'all' ? db.lives : db.lives.filter(l => l.artist === filterArtist);
    
    const counts = {};
    targetLives.forEach(l => {
        if (l.pref && l.pref !== 'æµ·å¤–') {
            counts[l.pref] = (counts[l.pref] || 0) + 1;
        }
    });

    // æœ€å¤§è¨ªå•å›æ•°ã‚’å–å¾—ï¼ˆè‰²ã®æ¿ƒã•ã®åŸºæº–ã«ã™ã‚‹ï¼‰
    const maxVisit = Math.max(...Object.values(counts), 0);

    const s = 22; 
    const ox = 75, oy = 20;

    // éƒ½é“åºœçœŒé…ç½®ãƒ‡ãƒ¼ã‚¿ï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
    const mapData = [
        {p:'åŒ—æµ·é“', x:ox+s*9, y:oy+s*0, w:s*3, h:s*2, big:true},
        {p:'é’æ£®çœŒ', x:ox+s*9, y:oy+s*3, w:s*2, h:s},
        {p:'ç§‹ç”°çœŒ', x:ox+s*9, y:oy+s*4}, {p:'å²©æ‰‹çœŒ', x:ox+s*10, y:oy+s*4},
        {p:'å±±å½¢çœŒ', x:ox+s*9, y:oy+s*5}, {p:'å®®åŸçœŒ', x:ox+s*10, y:oy+s*5},
        {p:'ç¦å³¶çœŒ', x:ox+s*9, y:oy+s*6, w:s*2, h:s},
        {p:'æ–°æ½ŸçœŒ', x:ox+s*7, y:oy+s*6, w:s*2, h:s},
        {p:'å¯Œå±±çœŒ', x:ox+s*6, y:oy+s*6}, {p:'çŸ³å·çœŒ', x:ox+s*5, y:oy+s*6},
        {p:'é•·é‡çœŒ', x:ox+s*7, y:oy+s*7, w:s, h:s*2},
        {p:'ç¦äº•çœŒ', x:ox+s*5, y:oy+s*7},
        {p:'å²é˜œçœŒ', x:ox+s*6, y:oy+s*7, w:s, h:s*2},
        {p:'å±±æ¢¨çœŒ', x:ox+s*8, y:oy+s*8}, {p:'æ„›çŸ¥çœŒ', x:ox+s*6, y:oy+s*9},
        {p:'é™å²¡çœŒ', x:ox+s*7, y:oy+s*9},
        {p:'æ ƒæœ¨çœŒ', x:ox+s*9, y:oy+s*7}, {p:'ç¾¤é¦¬çœŒ', x:ox+s*8, y:oy+s*7},
        {p:'èŒ¨åŸçœŒ', x:ox+s*10, y:oy+s*7, w:s, h:s*2}, {p:'åŸ¼ç‰çœŒ', x:ox+s*9, y:oy+s*8},
        {p:'åƒè‘‰çœŒ', x:ox+s*10, y:oy+s*9, w:s, h:s*2},
        {p:'æ±äº¬éƒ½', x:ox+s*9, y:oy+s*9}, {p:'ç¥å¥ˆå·çœŒ', x:ox+s*8, y:oy+s*9},
        {p:'æ»‹è³€çœŒ', x:ox+s*5, y:oy+s*8}, {p:'äº¬éƒ½åºœ', x:ox+s*4, y:oy+s*7},
        {p:'å¤§é˜ªåºœ', x:ox+s*4, y:oy+s*8}, {p:'å¥ˆè‰¯çœŒ', x:ox+s*4, y:oy+s*9},
        {p:'ä¸‰é‡çœŒ', x:ox+s*5, y:oy+s*9},
        {p:'å…µåº«çœŒ', x:ox+s*3, y:oy+s*7, w:s, h:s*2},
        {p:'å’Œæ­Œå±±çœŒ', x:ox+s*4, y:oy+s*10, w:s*2, h:s},
        {p:'é³¥å–çœŒ', x:ox+s*2, y:oy+s*7}, {p:'å³¶æ ¹çœŒ', x:ox+s*1, y:oy+s*7},
        {p:'å²¡å±±çœŒ', x:ox+s*2, y:oy+s*8},
        {p:'åºƒå³¶çœŒ', x:ox+s*1, y:oy+s*8},
        {p:'å±±å£çœŒ', x:ox+s*0, y:oy+s*7, w:s, h:s*2},
        {p:'é¦™å·çœŒ', x:ox+s*1, y:oy+s*10}, {p:'å¾³å³¶çœŒ', x:ox+s*2, y:oy+s*10},
        {p:'æ„›åª›çœŒ', x:ox+s*1, y:oy+s*11}, {p:'é«˜çŸ¥çœŒ', x:ox+s*2, y:oy+s*11},
        {p:'ç¦å²¡çœŒ', x:ox-s*2, y:oy+s*8}, {p:'ä½è³€çœŒ', x:ox-s*3, y:oy+s*8}, {p:'å¤§åˆ†çœŒ', x:ox-s*2, y:oy+s*9},
        {p:'é•·å´çœŒ', x:ox-s*3, y:oy+s*9}, {p:'ç†Šæœ¬çœŒ', x:ox-s*3, y:oy+s*10}, {p:'å®®å´çœŒ', x:ox-s*2, y:oy+s*10},
        {p:'é¹¿å…å³¶çœŒ', x:ox-s*3, y:oy+s*11, w:s*2, h:s},
        {p:'æ²–ç¸„çœŒ', x:ox-s*3, y:oy+s*14}
    ];

    let svgHtml = `<svg viewBox="0 0 350 420" width="100%" height="auto">`;

    mapData.forEach(d => {
        const count = counts[d.p] || 0;
        const isVisited = count > 0;
        
        // æ¿ƒæ·¡ã®è¨ˆç®—: å›æ•°ãŒå¤šã„ã»ã©ä¸é€æ˜åº¦(opacity)ã‚’ä¸Šã’ã‚‹ (æœ€å°0.2, æœ€å¤§1.0)
        // 1å›ã ã‘ã®ã¨ãã¯å°‘ã—è–„ãã€å›æ•°ãŒå¢—ãˆã‚‹ã»ã©ãƒ‘ã‚­ãƒƒã¨ã—ãŸç·‘ã«ãªã‚Šã¾ã™
        const opacity = isVisited ? Math.max(0.2, count / maxVisit) : 1;
        const color = isVisited ? `rgba(0, 113, 48, ${opacity})` : '#f2f2f7';
        const textColor = isVisited ? (opacity > 0.5 ? '#ffffff' : '#007130') : '#8e8e93';
        
        const w = d.w || s;
        const h = d.h || s;
        const displayCode = prefCodes[d.p] || d.p.charAt(0);
        const fontSize = d.big ? 11 : 7.5;
        
        svgHtml += `
            <g style="cursor:pointer;" onclick="toggleStatsDetail('detail-stats-pref-ranking-manual', 'stats-pref-ranking', '${d.p}')">
                <rect x="${d.x}" y="${d.y}" width="${w}" height="${h}" rx="2" fill="${color}" stroke="#ffffff" stroke-width="0.5" />
                <text x="${d.x + w/2}" y="${d.y + h/2 + 3}" font-size="${fontSize}" font-weight="900" text-anchor="middle" fill="${textColor}" style="pointer-events:none; font-family: -apple-system, sans-serif;">${displayCode}</text>
            </g>`;
    });
    
    container.innerHTML = svgHtml + `</svg>
    <div id="detail-stats-pref-ranking-manual" class="stats-detail-list hidden" style="margin-top:10px;"></div>`;
}


// ç®¡ç†ç”»é¢ã®ãƒªã‚¹ãƒˆã‚’æç”»ã™ã‚‹é–¢æ•°
function renderArtistManager() {
    const searchInput = document.getElementById('artist-search-input');
    const q = searchInput ? searchInput.value.toLowerCase() : "";
    const listContainer = document.getElementById('artist-manager-list');
    
    if (!listContainer) return;

    listContainer.innerHTML = db.artists
        .filter(a => a.toLowerCase().includes(q))
        .sort()
        .map(a => `
            <div class="artist-admin-row">
                <span class="artist-name-text">${a}</span>
                <div class="admin-btn-group">
                    <button onclick="editArtistName('${a}')" class="btn-mini btn-edit">ç·¨é›†</button>
                    <button onclick="deleteArtist('${a}')" class="btn-mini btn-delete">å‰Šé™¤</button>
                </div>
            </div>`).join('') || '<div style="padding:20px; text-align:center; color:#8e8e93;">è©²å½“ãªã—</div>';
}

// showPageé–¢æ•°å†…ã®IDæŒ‡å®šã‚’ä¿®æ­£ï¼ˆpage-settingsã«åˆã‚ã›ã¦ï¼‰
function showPage(id) {
    document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-bar button').forEach(b => b.classList.remove('active'));
    
    const targetPage = document.getElementById('page-' + id);
    if (targetPage) {
        targetPage.classList.add('active');
    }
    
    const targetTab = document.getElementById('tab-' + id);
    if (targetTab) {
        targetTab.classList.add('active');
    }

    if(id==='history') renderHistory();
    if(id==='stats') renderStats();
    if(id==='settings') renderArtistManager(); // ã“ã‚Œã§æ­£ã—ãå‘¼ã°ã‚Œã¾ã™
}


        function filterArtists() { renderArtistManager(); }

        function editArtistName(old) {
            const n = prompt('æ–°ã—ã„åå‰', old);
            if (!n || n === old) return;

            // 1. ã™ã§ã«ãã®åå‰ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const exists = db.artists.includes(n);

            if (exists) {
                if (confirm(`ã€Œ${n}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚å±¥æ­´ã‚’çµ±åˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                    // æ—¢å­˜ã®Aã«çµ±åˆã™ã‚‹å ´åˆï¼šå¤ã„Bã‚’å‰Šé™¤ã™ã‚‹ã ã‘ï¼ˆå±¥æ­´ã¯ä¸‹ã®å‡¦ç†ã§Aã«æ›¸ãæ›ã‚ã‚‹ï¼‰
                    db.artists = db.artists.filter(a => a !== old);
                } else {
                    return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                }
            } else {
                // å­˜åœ¨ã—ãªã„åå‰ãªã‚‰ã€æ™®é€šã«åå‰ã‚’ä¸Šæ›¸ã
                db.artists[db.artists.indexOf(old)] = n;
            }

            // 2. å±¥æ­´ï¼ˆlivesï¼‰ã®ä¸­ã«ã‚ã‚‹ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’ã™ã¹ã¦æ–°ã—ã„åå‰ã«æ›¸ãæ›ãˆã‚‹
            db.lives.forEach(l => {
                if (l.artist === old) l.artist = n;
            });

            save();
            renderArtistManager();
            if(document.getElementById('page-history').classList.contains('active')) renderHistory();
        }

// --- ã‚·ã‚§ã‚¢ãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼šã“ã“ã‹ã‚‰ ---
let selectedThemeColor = '#007130'; 

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãéš›ã«é¸æŠè‚¢ã‚’æœ€æ–°ã«ã™ã‚‹
function openShareModal() {
    // æœŸé–“ï¼ˆå¹´ï¼‰ã®é¸æŠè‚¢ã‚’è‡ªå‹•ç”Ÿæˆ
    const periodSelect = document.getElementById('share-period-type');
    const years = [...new Set(db.lives.map(l => l.date.split('-')[0]))].sort().reverse();
    
    periodSelect.innerHTML = '<option value="all">ALL TIMEï¼ˆå…¨æœŸé–“ï¼‰</option>';
    years.forEach(y => {
        if(y) periodSelect.innerHTML += `<option value="${y}">${y}å¹´ (Yearly)</option>`;
    });

    // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®é¸æŠè‚¢ã‚’è‡ªå‹•ç”Ÿæˆ
    const artistSelect = document.getElementById('share-artist-type');
    artistSelect.innerHTML = '<option value="all">ALL Artistsï¼ˆå…¨å¯¾è±¡ï¼‰</option>';
    db.artists.sort().forEach(a => {
        artistSelect.innerHTML += `<option value="${a}">${a}</option>`;
    });

    document.getElementById('share-modal').classList.remove('hidden');
}


function closeShareModal() {
    document.getElementById('share-modal').classList.add('hidden');
}

function setTheme(color) {
    selectedThemeColor = color;
    const btn = document.querySelector('#share-modal .accent-btn');
    if(btn) {
        btn.style.background = color;
        
        // è‰²ã®æ˜ã‚‹ã•ã‚’åˆ¤å®šã—ã¦ã€æ–‡å­—è‰²ã‚’é»’ã‹ç™½ã«è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆã‚‹
        const c = color.replace('#', '');
        const r = parseInt(c.substr(0,2), 16);
        const g = parseInt(c.substr(2,2), 16);
        const b = parseInt(c.substr(4,2), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        
        // æ˜ã‚‹ã„è‰²ã®ã¨ãã¯æ–‡å­—ã‚’é»’(#333)ã€æš—ã„è‰²ã®ã¨ãã¯ç™½ã«
        btn.style.color = brightness > 150 ? '#333' : '#fff';
        
        // ç™½ã®ã¨ãã ã‘ãƒœã‚¿ãƒ³ã«è–„ã„æ ç·šã‚’ã¤ã‘ã‚‹ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ç”¨ï¼‰
        btn.style.border = brightness > 240 ? '1px solid #ccc' : 'none';
    }
}

function toggleShareFilter() {
    const type = document.getElementById('share-type').value;
    const detail = document.getElementById('share-filter-detail');
    if(!detail) return;
    detail.innerHTML = '';

    if (type === 'annual') {
        const years = [...new Set(db.lives.map(l => l.date.split('-')[0]))].sort().reverse();
        detail.innerHTML = `<select id="filter-year" style="margin-top:10px;">${years.length ? years.map(y => `<option value="${y}">${y}å¹´</option>`).join('') : '<option value="">å±¥æ­´ãªã—</option>'}</select>`;
    } else if (type === 'monthly') {
        detail.innerHTML = `<input type="month" id="filter-month" value="${new Date().toISOString().slice(0, 7)}" style="margin-top:10px;">`;
    } else if (type === 'artist') {
        detail.innerHTML = `<select id="filter-artist" style="margin-top:10px;">${db.artists.length ? db.artists.sort().map(a => `<option value="${a}">${a}</option>`).join('') : '<option value="">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãªã—</option>'}</select>`;
    }
}

// é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ã®å¼·åŒ–
function calculateReportStats(lives) {
    const songCounts = {};
    const venueCounts = {};
    const prefCounts = {};
    const artistCounts = {};
    let totalSongs = 0;

    lives.forEach(l => {
        if(l.artist) artistCounts[l.artist] = (artistCounts[l.artist] || 0) + 1;
        if(l.venue) venueCounts[l.venue] = (venueCounts[l.venue] || 0) + 1;
        if(l.pref) prefCounts[l.pref] = (prefCounts[l.pref] || 0) + 1;
        if (l.setlist) {
            totalSongs += l.setlist.length;
            l.setlist.forEach(s => songCounts[s] = (songCounts[s] || 0) + 1);
        }
    });

    // --- ã“ã“ã‹ã‚‰ getTop ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ ---
    const getTop = (obj) => {
        const entries = Object.entries(obj).sort((a, b) => b[1] - a[1]);
        if (entries.length === 0) return { text: "-", count: 0, others: 0 };
        
        const maxCount = entries[0][1];
        const tops = entries.filter(e => e[1] === maxCount);
        
        // 2ä½ã¾ã§ã‚’æ”¹è¡Œã§ã¤ãªãã€‚3ä½ä»¥é™ãŒã‚ã‚Œã°ãã®ä»¶æ•°ã‚’æ•°ãˆã‚‹
        let displayText = tops.slice(0, 2).map(e => e[0]).join('<br>');
        let othersCount = tops.length > 2 ? tops.length - 2 : 0;
        
        return {
            text: displayText,
            count: maxCount,
            others: othersCount
        };
    };

    return {
        totalLives: lives.length,
        totalArtists: Object.keys(artistCounts).length,
        totalSongs: totalSongs,
        totalVenues: Object.keys(venueCounts).length,
        totalPrefs: Object.keys(prefCounts).length,
        // å„é …ç›®ã‚’æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§è¿”ã™
        topArtist: getTop(artistCounts),
        topSong: getTop(songCounts),
        topVenue: getTop(venueCounts),
        topPref: getTop(prefCounts)
    };
}

// ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆæ–°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
function generateReport() {
    const selectedYear = document.getElementById('share-period-type').value;
    const selectedArtist = document.getElementById('share-artist-type').value;
    let filteredLives = db.lives;

    if (selectedYear !== 'all') filteredLives = filteredLives.filter(l => l.date.startsWith(selectedYear));
    if (selectedArtist !== 'all') filteredLives = filteredLives.filter(l => l.artist === selectedArtist);

    if (filteredLives.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    const stats = calculateReportStats(filteredLives);
    const container = document.getElementById('report-card-container');
    const periodDisplay = selectedYear === 'all' ? 'ALL TIME' : selectedYear + ' YEAR';

    // èƒŒæ™¯ã®æ˜ã‚‹ã•ã‚’åˆ¤å®šã—ã¦æ–‡å­—è‰²ã‚’æ±ºå®š
    const hex = selectedThemeColor.replace('#', '');
    const r = parseInt(hex.substr(0,2), 16);
    const g = parseInt(hex.substr(2,2), 16);
    const b = parseInt(hex.substr(4,2), 16);
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    const isLight = brightness > 180;

    // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®æ–‡å­—è‰²ã‚¯ãƒ©ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
    container.className = isLight ? 'report-theme-light' : 'report-theme-dark';
    
    // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã‚’é©ç”¨ï¼ˆæ¨ã—è‰² â†’ å°‘ã—æ¿ƒã„è‰²ã¸ã®æ–œã‚ã‚°ãƒ©ãƒ‡ï¼‰
    container.style.background = `linear-gradient(135deg, ${selectedThemeColor} 0%, ${adjustColor(selectedThemeColor, -30)} 100%)`;

    container.innerHTML = `
        <div class="report-header">
            <div class="report-title">LIVE PERFORMANCE RECORD</div>
            <div class="report-period">${periodDisplay} / ${selectedArtist === 'all' ? 'ALL ARTISTS' : selectedArtist}</div>
        </div>
        
        <div class="report-section-label">TOTAL STATS</div>
        <div class="report-grid-mini">
            <div class="report-item"><span class="report-label">ãƒ©ã‚¤ãƒ–æ•°</span><span class="report-value">${stats.totalLives}</span></div>
            <div class="report-item"><span class="report-label">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</span><span class="report-value">${stats.totalArtists}</span></div>
            <div class="report-item"><span class="report-label">æ›²æ•°</span><span class="report-value">${stats.totalSongs}</span></div>
            <div class="report-item"><span class="report-label">ä¼šå ´æ•°</span><span class="report-value">${stats.totalVenues}</span></div>
            <div class="report-item"><span class="report-label">åˆ¶è¦‡éƒ½é“åºœçœŒ</span><span class="report-value">${stats.totalPrefs}<small>/47</small></span></div>
        </div>

        <div class="report-section-label" style="margin-top:15px;">TOP RECORDS</div>

<div class="report-best-list">
    ${[
        { label: 'BEST ARTIST', data: stats.topArtist },
        { label: 'BEST MUSIC', data: stats.topSong },
        { label: 'BEST PLACE', data: stats.topVenue }
    ].map(item => `
        <div class="best-entry">
            <span class="report-label">${item.label}</span>
            <div class="best-main-content">
                <div class="report-value-long">${item.data.text}</div>
                ${item.data.others > 0 ? `<div class="report-others-count">ï¼‹ ä»–${item.data.others}ä»¶</div>` : ''}
                <div class="best-count-display">${item.data.count}<small>å›</small></div>
            </div>
        </div>
    `).join('')}
</div>

        <div class="report-footer">Generated by LIVE DIARY ğŸŠ</div>
    `;

// generateReport é–¢æ•°ã®æœ€å¾Œï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ç›´å‰ï¼‰ã«ã“ã‚Œã‚’è¿½åŠ 
const reportCard = document.getElementById('report-card-container');
const windowHeight = window.innerHeight;
const safeHeight = windowHeight * 0.8; // ç”»é¢ã®8å‰²ã®é«˜ã•ã«åã‚ã‚‹

// ã‚«ãƒ¼ãƒ‰ã®å®Ÿéš›ã®é«˜ã•ã‚’å–å¾—ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨ˆç®—
reportCard.style.transform = 'scale(1)'; // ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
const cardHeight = reportCard.offsetHeight;

if (cardHeight > safeHeight) {
    const scale = safeHeight / cardHeight;
    reportCard.style.transform = `scale(${scale})`;
    reportCard.style.transformOrigin = 'top center';
} else {
    reportCard.style.transform = 'scale(1)';
}





    document.getElementById('report-preview-overlay').classList.remove('hidden');
    closeShareModal();
}

// è‰²ã‚’æš—ãã™ã‚‹è£œåŠ©é–¢æ•°
function adjustColor(color, percent) {
    const num = parseInt(color.replace('#',''),16),
    amt = Math.round(2.55 * percent),
    R = (num >> 16) + amt,
    G = (num >> 8 & 0x00FF) + amt,
    B = (num & 0x0000FF) + amt;
    return "#" + (0x1000000 + (R<255?R<0?0:R:255)*0x10000 + (G<255?G<0?0:G:255)*0x100 + (B<255?B<0?0:B:255)).toString(16).slice(1);
}


// --- ç”»åƒä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆhtml2canvasã‚’ä½¿ç”¨ï¼‰ ---
// ç”»åƒä¿å­˜ãƒ»å…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ç‰ˆ
async function saveReportImage() {
    const card = document.getElementById('report-card-container');
    
    // 1. ã‚­ãƒ£ãƒ—ãƒãƒ£ç”¨ã«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’ä¸€æ™‚è§£é™¤
    const originalTransform = card.style.transform;
    card.style.transform = 'scale(1)';

    try {
        const canvas = await html2canvas(card, {
            backgroundColor: null,
            scale: 2,
            useCORS: true,
            logging: false
        });

        // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’å…ƒã«æˆ»ã™
        card.style.transform = originalTransform;

        // 2. Blobï¼ˆãƒ‡ãƒ¼ã‚¿ã®ã‹ãŸã¾ã‚Šï¼‰ã«å¤‰æ›
        canvas.toBlob(async (blob) => {
            const file = new File([blob], "LIVE_REPORT.png", { type: "image/png" });

            // 3. Web Share API ã‚’ä½¿ç”¨ã—ã¦å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‘¼ã³å‡ºã™ï¼ˆiPhone/Androidç”¨ï¼‰
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'LIVE REPORT',
                    });
                } catch (err) {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
                    if (err.name !== 'AbortError') console.error("å…±æœ‰å¤±æ•—:", err);
                }
            } else {
                // 4. PCã‚„æœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¾“æ¥ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
                const link = document.createElement('a');
                const dateStr = new Date().toISOString().slice(0,10).replace(/-/g, '');
                link.download = `LIVE_REPORT_${dateStr}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                alert("å…±æœ‰æ©Ÿèƒ½ãŒæœªå¯¾å¿œã®ãŸã‚ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
            }
        }, 'image/png');

    } catch (e) {
        console.error("ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", e);
        card.style.transform = originalTransform;
        alert("ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
}


// --- ã‚·ã‚§ã‚¢ãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼šã“ã“ã¾ã§ ---

        function deleteArtist(n) { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ db.artists=db.artists.filter(a=>a!==n); db.lives=db.lives.filter(l=>l.artist!==n); save(); renderArtistManager(); } }
        function exportData() { const blob = new Blob([JSON.stringify(db)], {type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='livelog.json'; a.click(); }
        function importData(e) { const f = e.target.files[0]; const r = new FileReader(); r.onload = (ev) => { db = JSON.parse(ev.target.result); save(); location.reload(); }; r.readAsText(f); }
    </script>
</body>
</html>
